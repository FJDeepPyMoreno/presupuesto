<section class="policies-breakdown" id="tab-monitoring-content">
  <h3 class="policies-title">Desglose por secciones</h3>

  <!-- Collapsable -->
  <ul class="monitoring-list">

    {% for section in monitoring_sections %}
    <li>
      <a class="monitoring-block collapsed" data-toggle="collapse" href="#section-{{ loop.index }}" role="button" aria-expanded="false" aria-controls="section-{{ loop.index }}">
        <h4 class="monitoring-title">{{ section }}</h4>
        <!-- FIXME: Progress percentage hardcoded. -->
        <!-- FIXME: And only visible for first section?! -->
        <div data-result="71.1" class="bar-chart"></div>
      </a>

      <div class="collapse" id="section-{{ loop.index }}">

        <h5>Objetivos</h5>
        <ol class="goals-list">
          <!-- FIXME: This is VERY temporary code, it's clearly VERY inefficient. Moving to Javascript probably -->
          {% for goal in monitoring_goals %}
            {% if section == goal.institutional_category %}
            <li>
              <div>
                <!-- Objective title -->
                <!-- FIXME: Goals are probably not ordered correctly right now, so I'm printing the number myself to check -->
                <h6 class="goal-title">{{ goal.goal_number }} {{ goal.description }}</h6>

                <!-- Objective description -->
                <div class="goal-report">
                  <!-- FIXME: Don't create this if there is no text -->
                  <p class="collapse" id="collapseSummary-{{ loop.index }}">{{ goal.report|safe }}</p>
                  <a class="collapsed" data-toggle="collapse" href="#collapseSummary-{{ loop.index }}" aria-expanded="false" aria-controls="collapseSummary-{{ loop.index }}"></a>
                </div>

                <!-- Activities table -->
                <table class="table-activities">
                  <tr>
                    <th>Actividades</th>
                  </tr>
                  {% for activity in monitoring_activities %}
                    {% if activity.goal.uid == goal.uid %}
                    <tr>
                      <td>{{ activity }}</td>
                    </tr>
                    {% endif %}
                  {% endfor %}
                </table>

                <!-- Indicators table -->
                <table  class="table-indicators">
                  <tr>
                    <th>Indicadores</th>
                    <th>Presupuestado</th>
                    <th>Realizado</th>
                    <th class="opacity-0">Cobertura</th>
                  </tr>

                  {% for indicator in monitoring_indicators %}
                    {% if indicator.goal.uid == goal.uid %}
                      <tr>
                        <td>{{ indicator.description }} <span class="indicator-unit">({{ indicator.unit }})</span></td>
                        <!-- FIXME: Should format these numbers -->
                        <td>{{ indicator.target }}</td>
                        <td>{{ indicator.actual }}</td>
                        <td>
                          <span
                            class="coverage-icon level-{{ '{0:.0f}'.format((indicator.score)*4) }}"
                            title="{{ '{0:0.1f}'.format(indicator.score*100) }}%"/>
                        </td>
                      </tr>
                    {% endif %}
                  {% endfor %}
                </table>

              </div>
            </li>
            {% endif %}
          {% endfor %}
        </ol>
      </div>
    </li>
    {% endfor %}
  </ul>
</section>

<!-- FIXME: Temporary solution: accessing d3 via npm -->
<script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
<script>
  const barEl = d3.select(".bar-chart");
  const datum = barEl.attr("data-result");

  const brandPrimary = "#003DF6"; // not able to access CSS variables from here
  
  const elementWidth = 250;
  const textWidth = 70;
  const barWidth = elementWidth-textWidth;
  const barHeight = 20;
  const fillWidth = datum * barWidth / 100;

  barEl
    .style("width", `${elementWidth}px`)
    .style("display", "flex")
    .style("direction", "row")

  const divEls = barEl.append("div").style("position", "relative")
  divEls
    .append("div")
    .attr("class", "bar-outline")
    .style("width", `${barWidth}px`)
    .style("height", `${barHeight}px`)
    .style("border", `2px solid ${brandPrimary}`)
    .style("position", "absolute")
  divEls
    .append("div")
    .attr("class", "bar-fill")
    .style("width", `${fillWidth}px`)
    .style("height", `${barHeight}px`)
    .style("background-color", brandPrimary)
    .style("position", "absolute")

  barEl.append("span")
    .style("color", brandPrimary)
    .style("margin-left", "10px")
    .style("vertical-align", "top")
    .style("width", "100%")
    .style("font-weight", 800)
    .style("text-align", "right")
    .text(`${datum} %`)
</script>
